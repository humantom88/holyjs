# WebAssembly без купюр

Опыт Яндекс Карт
---
- Backend присылает tiles
- Более полугода Яндекс Карты трехмерные
- Приходит в protobuf, там написано что нужно нарисовать
- Полигоны надо разбить на треугольники - триангуляция
- Все эти данные загружаются в WebGL буфер и данные отправляются в видеокарту
- Часть кода переписаны в C++ и собраны на WA
- В некоторых местах производительность выросла в 10 раз. 
- Первые тайлы стали грузиться быстрее в 3 раза в среднем
- Вся работа ускорилась на 20-25%

Минусы:
- параллельная кодовая база на C++
- Параллельный разработчик
- Параллельные баги
- сильно увеличивает размер бандла
- не подходит для всего приложения: много дополнительного кода и накладных расходов

Скоро будет статья в блоге Яндекса на хабре

Moscow JS Geo Meetup видео
---
Что такое WebAssembly
---

Потративный, компактный низкоуровневый бинарный формат, выполняющийся на скорости близкой к нативной

Идейный наследник AsmJS, направлен на C++

Web - подразумевает, что код будет выполняться в вебе

WebAssembly - виртуальная машина в браузере

- .net, jvm, vlash, js (Абстрактные машины)
- wasm (виртуальная машина, не привязанная к железу, остальное из низкоуровневых вещей)
- x96/arm/... nacl (бинарник процессора, который хром загружает из инета и исполняется на машине)

Как устроен:

- module
- code

Типы данных
- Числа с плавающей точкой
- Целые числа

type.operation
- обычная математика
- битовые операции
- операции сравнения

Все инструкции выполняются на стековой машине
- снимать значение
- удалять
- снимать, модифицировать и складывать обратно

WebAsm интегрирован с JS

memory (new ArrayBuffer(n * 65536))
- можно читать
- можно писать
- память little endian

Flow Control
- if else
- while

Можно экспортировать функции из модуля WebAsm и импортировать модуль WebAsm из/в JS

И это все!
---

Как это работает?
---

Программируем на WebAssembly
---
Вы скорее всего не будете писать на WebAssembly руками
```c++
(module
    (export "fo1_const" (func $f01_const))

    (func $f01_const (result i32)
        i32.const 42
        :: [] => [42]
    )

)
```

Проблема со "Сложными типами" (Придется все сериализовать)
---
Будущее
--
Версионирование
- WebAssembly 1.0 можно использовать в любом браузере

в WebAssembly есть proposal 
- anyref
- SIMD (Scalar Operation)
- Exceptions
- Bulk Operations (memset, memcpy) WebAssembly/bulk-memory-operations
- Threads WebAssembly/thread
- Garbage Collection WebAssembly/gc
- ...
- и еще куча всего 

- В IE11 нет полифила
- Javascript нельзя просто перекомпилировать в wasm
- Внутри wasm нельзя скомпилировать wasm и сделать JIT
- Из jvm/.net нельзя притащить фичи для использование в wasm

- Нельзя сделать SEGFAULT
- Нельзя перезаписать адрес возврата
- Нельзя перезаписать код
- Нельзя получить доступ к файловой системе или сети
- Это не новый activex, все безопасносто

---
В ASM могут собираться C++ (emscripten), Rust(bindgen)
---
Все, что умеет собираться в LLVM, можно собрать в wasm
--- 
Браузерные движки
- v8
- SpiderMonkey
- ChakraCore
- JavascriptCore

Самостоятельные движки
- binaryen
- ...
- ...

Webasm можно запустить нативно на любой ОС

- Портировать библиотеку, или софт
- Числодробилки: фото/видео редакторы, игры
- Использовать один код на бэке и на фронте
- Перенос экспертизы ваших коллег из соседней области (blazor)
---
Tools
---
- WasmExplorer
- WasmFiddle
- WasmCodeExplorer
- WebAssembly Studio (The best)

что почитать:
Фото